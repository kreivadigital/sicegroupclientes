<app-modal [title]="getTitle()" [size]="'lg'" (close)="onClose()">
  @if (loading()) {
  <div class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>
  } @else {
  <form [formGroup]="form" (ngSubmit)="onSubmit()">
    <div class="row">
      <!-- Cliente -->
      <div class="col-12 mb-3">
        <label class="form-label">Cliente <span class="text-dark">(*)</span></label>
        @if (mode === 'view' && order()) {
        <input
          type="text"
          class="form-control"
          [value]="order()?.client?.company_name || ''"
          readonly
        />
        } @else {
        <app-searchable-select
          formControlName="client_id"
          [options]="clientOptions()"
          placeholder="Seleccionar cliente"
          searchPlaceholder="Buscar cliente..."
        ></app-searchable-select>
        }
      </div>

      <!-- Descripción y Dirección de entrega -->
      <div class="col-md-6 mb-3">
        <label class="form-label">Descripción @if (auth.isAdmin()) {(opcional)}</label>
        <textarea
          class="form-control"
          rows="3"
          formControlName="description"
          placeholder="Ej: 50 cajas de electrónicos"
        ></textarea>
      </div>

      <div class="col-md-6 mb-3">
        <label class="form-label">Dirección de entrega <span class="text-dark">(*)</span></label>
        <textarea
          class="form-control"
          rows="3"
          formControlName="delivery_address"
          placeholder="Ej: Av. Agraciada 456, Bodega 1"
        ></textarea>
        @if (form.get('delivery_address')?.invalid && form.get('delivery_address')?.touched) {
        <div class="text-danger small mt-1">Este campo es requerido</div>
        }
      </div>

      <!-- Cantidad de bultos y Packin list -->
      <div class="col-md-6 mb-3">
        <label class="form-label">Cantidad de bultos <span class="text-dark">(*)</span></label>
        <input
          type="number"
          class="form-control"
          formControlName="package_count"
          placeholder="0"
          min="1"
        />
        @if (form.get('package_count')?.invalid && form.get('package_count')?.touched) {
        <div class="text-danger small mt-1">Este campo es requerido (mínimo 1)</div>
        }
      </div>

      <div class="col-md-6 mb-3">
        <label class="form-label">Picking list @if (auth.isAdmin()) {(opcional)}</label>
        @if (mode === 'view') { @if (order()?.picking_list_path) {
        <div class="file-display" (click)="downloadFile('picking-list')">
          <i class="bi bi-file-earmark-spreadsheet me-2"></i>
          <span>{{ truncateFileName(getFileName(order()?.picking_list_path)) }}</span>
          <button
            type="button"
            class="btn btn-sm btn-link"
            (click)="downloadFile('picking-list'); $event.stopPropagation()"
          >
            <i class="bi bi-download"></i>
          </button>
        </div>
        } @else {
        <input type="text" class="form-control" value="No adjuntado" readonly />
        } } @else { @if (auth.isAdmin()) {
        <!-- Wrapper con soporte para barra de progreso -->
        <div class="file-input-wrapper" [class.uploading]="fileStates.picking.uploading">
          @if (fileStates.picking.file) {
          <!-- Archivo nuevo seleccionado o en carga -->
          <div class="file-display file-selected">
            <div class="file-info">
              <i class="bi bi-file-earmark-spreadsheet me-2"></i>
              <span>{{ truncateFileName(fileStates.picking.file.name) }}</span>
            </div>
            <div class="file-actions">
              <!-- Spinner mientras sube -->
              @if (fileStates.picking.uploading) {
              <i class="bi bi-hourglass-split spin text-primary me-2"></i>
              }
              <!-- Check cuando completa -->
              @if (fileStates.picking.completed) {
              <i class="bi bi-check-circle-fill text-success me-2"></i>
              }
              <!-- Botones solo si NO está subiendo -->
              @if (!fileStates.picking.uploading) {
              <button
                type="button"
                class="btn btn-sm btn-link"
                [disabled]="isFileUploadDisabled('picking')"
                (click)="handleFileButtonClick('picking', packinInput)">
                <i class="bi bi-pencil"></i>
              </button>
              <button type="button" class="btn btn-sm btn-link text-danger" (click)="removeFile('picking')">
                <i class="bi bi-trash"></i>
              </button>
              }
            </div>
          </div>
          <!-- Barra de progreso visual -->
          @if (fileStates.picking.uploading) {
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="fileStates.picking.progress"></div>
          </div>
          }
          } @else if (order()?.picking_list_path) {
          <!-- Archivo existente en servidor -->
          <div class="file-display file-existing">
            <i class="bi bi-file-earmark-spreadsheet me-2"></i>
            <span>{{ truncateFileName(getFileName(order()?.picking_list_path)) }}</span>
            <button
              type="button"
              class="btn btn-sm btn-link"
              [disabled]="isFileUploadDisabled('picking')"
              (click)="handleFileButtonClick('picking', packinInput)">
              <i class="bi bi-pencil"></i>
            </button>
          </div>
          } @else {
          <!-- Sin archivo -->
          <button
            type="button"
            class="btn btn-secondary w-100"
            [disabled]="isFileUploadDisabled('picking')"
            (click)="handleFileButtonClick('picking', packinInput)">
            <i class="bi bi-upload me-2"></i>
            Adjuntar
          </button>
          }
        </div>
        <input
          #packinInput
          type="file"
          class="d-none"
          accept=".pdf,.xlsx,.xls"
          [disabled]="isFileUploadDisabled('picking')"
          (change)="onFileSelect($event, 'picking')"
        />
        } @else {
        <input type="text" class="form-control" value="Solo visible en modo lectura" readonly />
        } }
      </div>

      <!-- PDF Proforma y Factura -->
      <div class="col-md-6 mb-3">
        <label class="form-label">Proforma @if (auth.isAdmin()) {(opcional)}</label>
        @if (mode === 'view') { @if (order()?.performa_pdf_path) {
        <div class="file-display" (click)="downloadFile('performa-pdf')">
          <i class="bi bi-file-earmark-pdf me-2"></i>
          <span>{{ truncateFileName(getFileName(order()?.performa_pdf_path)) }}</span>
          <button
            type="button"
            class="btn btn-sm btn-link"
            (click)="downloadFile('performa-pdf'); $event.stopPropagation()"
          >
            <i class="bi bi-download"></i>
          </button>
        </div>
        } @else {
        <input type="text" class="form-control" value="No adjuntado" readonly />
        } } @else { @if (auth.isAdmin()) {
        <!-- Wrapper con soporte para barra de progreso -->
        <div class="file-input-wrapper" [class.uploading]="fileStates.performa.uploading">
          @if (fileStates.performa.file) {
          <!-- Archivo nuevo seleccionado o en carga -->
          <div class="file-display file-selected">
            <div class="file-info">
              <i class="bi bi-file-earmark-pdf me-2"></i>
              <span>{{ truncateFileName(fileStates.performa.file.name) }}</span>
            </div>
            <div class="file-actions">
              @if (fileStates.performa.uploading) {
              <i class="bi bi-hourglass-split spin text-primary me-2"></i>
              }
              @if (fileStates.performa.completed) {
              <i class="bi bi-check-circle-fill text-success me-2"></i>
              }
              @if (!fileStates.performa.uploading) {
              <button
                type="button"
                class="btn btn-sm btn-link"
                [disabled]="isFileUploadDisabled('performa')"
                (click)="handleFileButtonClick('performa', performaInput)">
                <i class="bi bi-pencil"></i>
              </button>
              <button type="button" class="btn btn-sm btn-link text-danger" (click)="removeFile('performa')">
                <i class="bi bi-trash"></i>
              </button>
              }
            </div>
          </div>
          @if (fileStates.performa.uploading) {
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="fileStates.performa.progress"></div>
          </div>
          }
          } @else if (order()?.performa_pdf_path) {
          <!-- Archivo existente en servidor -->
          <div class="file-display file-existing">
            <i class="bi bi-file-earmark-pdf me-2"></i>
            <span>{{ truncateFileName(getFileName(order()?.performa_pdf_path)) }}</span>
            <button
              type="button"
              class="btn btn-sm btn-link"
              [disabled]="isFileUploadDisabled('performa')"
              (click)="handleFileButtonClick('performa', performaInput)">
              <i class="bi bi-pencil"></i>
            </button>
          </div>
          } @else {
          <!-- Sin archivo -->
          <button
            type="button"
            class="btn btn-secondary w-100"
            [disabled]="isFileUploadDisabled('performa')"
            (click)="handleFileButtonClick('performa', performaInput)">
            <i class="bi bi-upload me-2"></i>
            Adjuntar
          </button>
          }
        </div>
        <input
          #performaInput
          type="file"
          class="d-none"
          accept=".pdf,.xlsx,.xls"
          [disabled]="isFileUploadDisabled('performa')"
          (change)="onFileSelect($event, 'performa')"
        />
        } @else {
        <input type="text" class="form-control" value="Solo visible en modo lectura" readonly />
        } }
      </div>

      <div class="col-md-6 mb-3">
        <label class="form-label">Factura @if (auth.isAdmin()) {(opcional)}</label>
        @if (mode === 'view') { @if (order()?.invoice_path) {
        <div class="file-display" (click)="downloadFile('invoice')">
          <i class="bi bi-file-earmark-pdf me-2"></i>
          <span>{{ truncateFileName(getFileName(order()?.invoice_path)) }}</span>
          <button
            type="button"
            class="btn btn-sm btn-link"
            (click)="downloadFile('invoice'); $event.stopPropagation()"
          >
            <i class="bi bi-download"></i>
          </button>
        </div>
        } @else {
        <input type="text" class="form-control" value="No adjuntado" readonly />
        } } @else { @if (auth.isAdmin()) {
        <!-- Wrapper con soporte para barra de progreso -->
        <div class="file-input-wrapper" [class.uploading]="fileStates.invoice.uploading">
          @if (fileStates.invoice.file) {
          <!-- Archivo nuevo seleccionado o en carga -->
          <div class="file-display file-selected">
            <div class="file-info">
              <i class="bi bi-file-earmark-pdf me-2"></i>
              <span>{{ truncateFileName(fileStates.invoice.file.name) }}</span>
            </div>
            <div class="file-actions">
              @if (fileStates.invoice.uploading) {
              <i class="bi bi-hourglass-split spin text-primary me-2"></i>
              }
              @if (fileStates.invoice.completed) {
              <i class="bi bi-check-circle-fill text-success me-2"></i>
              }
              @if (!fileStates.invoice.uploading) {
              <button
                type="button"
                class="btn btn-sm btn-link"
                [disabled]="isFileUploadDisabled('invoice')"
                (click)="handleFileButtonClick('invoice', invoiceInput)">
                <i class="bi bi-pencil"></i>
              </button>
              <button type="button" class="btn btn-sm btn-link text-danger" (click)="removeFile('invoice')">
                <i class="bi bi-trash"></i>
              </button>
              }
            </div>
          </div>
          @if (fileStates.invoice.uploading) {
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="fileStates.invoice.progress"></div>
          </div>
          }
          } @else if (order()?.invoice_path) {
          <!-- Archivo existente en servidor -->
          <div class="file-display file-existing">
            <i class="bi bi-file-earmark-pdf me-2"></i>
            <span>{{ truncateFileName(getFileName(order()?.invoice_path)) }}</span>
            <button
              type="button"
              class="btn btn-sm btn-link"
              [disabled]="isFileUploadDisabled('invoice')"
              (click)="handleFileButtonClick('invoice', invoiceInput)">
              <i class="bi bi-pencil"></i>
            </button>
          </div>
          } @else {
          <!-- Sin archivo -->
          <button
            type="button"
            class="btn btn-secondary w-100"
            [disabled]="isFileUploadDisabled('invoice')"
            (click)="handleFileButtonClick('invoice', invoiceInput)">
            <i class="bi bi-upload me-2"></i>
            Adjuntar
          </button>
          }
        </div>
        <input
          #invoiceInput
          type="file"
          class="d-none"
          accept=".pdf,.xlsx,.xls"
          [disabled]="isFileUploadDisabled('invoice')"
          (change)="onFileSelect($event, 'invoice')"
        />
        } @else {
        <input type="text" class="form-control" value="Solo visible en modo lectura" readonly />
        } }
      </div>

      <!-- Estado y Contenedor -->
      <div class="col-md-6 mb-3">
        <label class="form-label">Estado</label>
        @if (mode === 'view' && order()) {
        <input
          type="text"
          class="form-control"
          [value]="getStatusLabel(order()?.status || '')"
          readonly
        />
        } @else {
        <select class="form-select" formControlName="status" [class.status-locked]="statusLocked()">
          <option value="pending">Pendiente</option>
          <option value="processing">En Proceso</option>
          <option value="shipped">En tránsito</option>
          <option value="delivered">Entregada</option>
          <option value="cancelled">Cancelada</option>
        </select>
        @if (statusLocked()) {
        <div class="status-locked-message">
          <i class="bi bi-info-circle me-1"></i>
          {{ statusLockedMessage() }}
        </div>
        } }
      </div>

      @if (auth.isAdmin()) {
      <div class="col-md-6 mb-3">
        <label class="form-label">Contenedor (opcional)</label>
        @if (mode === 'view') { @if (order()?.container) {
        <input
          type="text"
          class="form-control"
          [value]="
            order()?.container?.container_number + ' - ' + order()?.container?.shipment_reference ||
            ''
          "
          readonly
        />
        } @else {
        <input type="text" class="form-control" value="No asignado" readonly />
        } } @else { @if (auth.isAdmin()) {
        <select class="form-select" formControlName="container_id">
          <option value="">Seleccionar contenedor</option>
          @for (container of containers(); track container.id) {
          <option [value]="container.id">
            {{ container.container_number }} - {{ container.shipment_reference }}
          </option>
          }
        </select>
        } @else {
        <input type="text" class="form-control" value="Solo visible en modo lectura" readonly />
        } }
      </div>
      }
    </div>
  </form>
  }

  <!-- Footer -->
  <div footer>
    @if (mode === 'view') {
    <button type="button" class="btn btn-secondary" (click)="onClose()">Cerrar</button>
    } @else {
    <button type="button" class="btn btn-secondary" (click)="onClose()" [disabled]="loading()">
      Cancelar
    </button>
    <button
      type="button"
      class="btn btn-primary"
      (click)="onSubmit()"
      [disabled]="!canSaveOrder()"
    >
      @if (loading()) {
      <span class="spinner-border spinner-border-sm me-2"></span>
      }
      {{ mode === 'create' ? 'Agregar' : 'Actualizar' }}
    </button>
    }
  </div>
</app-modal>
