<app-modal [size]="'lg'" (close)="onClose()">
  <!-- Header con título y estado -->
  <div header class="d-flex align-items-center gap-3">
    <h2 class="modal-title mb-0">Rastreo de contenedor</h2>
    @if (container()) {
    <span [class]="getStatusBadgeClass(container()!.status)">
      {{ getStatusLabel(container()!.status) }}
    </span>
    }
  </div>

  @if (loading()) {
  <div class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>
  } @else if (container()) {
  <!-- Sección de Información del Contenedor -->
  <div class="info-section">
    <!-- Ícono en esquina superior derecha -->
    <div class="info-icon" title="Información adicional">
      <i class="bi bi-info-lg"></i>
    </div>

    <!-- Subsección: Números de Orden y Referencia -->
    <div class="info-numbers">
      @if (orderNumber) {
      <div class="info-item">
        <div class="info-label">Número de Orden</div>
        <div class="info-value">{{ orderNumber }}</div>
      </div>
      }
      <div class="info-item">
        <div class="info-label">Número de Referencia</div>
        <div class="info-value">{{ container()!.shipment_reference || '-' }}</div>
      </div>
      @if (showAddNotification) {
      <div class="info-item">
        <div class="info-label">Número de Contenedor</div>
        <div class="info-value">{{ container()!.container_number || '-' }}</div>
      </div>
      }
    </div>

    <!-- Subsección: Puertos -->
    <div class="info-ports">
      <div class="info-item">
        <div class="info-label">Puerto de Origen</div>
        <div class="info-value fw-bold">
          {{ container()!.port_of_loading_name || '-' }},
          {{ container()!.port_of_loading_country || '-' }}
        </div>
        <div class="info-date">{{ formatDate(container()!.date_of_loading) }}</div>
      </div>

      <div class="info-arrow">
        <div class="arrow-line"></div>
        <div class="arrow-circle"></div>
      </div>

      <div class="info-item">
        <div class="info-label">Puerto de Destino</div>
        <div class="info-value fw-bold">
          {{ container()!.destination_port_name || '-' }},
          {{ container()!.destination_port_country || '-' }}
        </div>
        <div class="info-date">{{ formatDate(container()!.date_of_discharge) }}</div>
      </div>
    </div>
  </div>

  <!-- Sección de Progreso del Envío -->
  <div class="progress-section">
    <h6 class="progress-title">Progreso del Envío</h6>
    <div class="progress-percentage">{{ getProgressPercentage() }}%</div>

    <div class="progress-tracker">
      <div class="progress-line">
        <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
      </div>

      @for (step of getProgressSteps(); track $index) {
      <div class="progress-step" [class.active]="step.active">
        <div class="step-icon">
          <i [class]="'bi ' + step.icon"></i>
        </div>
        <div class="step-label">{{ step.label }}</div>
      </div>
      }
    </div>
  </div>

  <!-- Sección de Mapa VesselFinder -->
  <div class="maps-section">
    @if (mapLoading()) {
    <!-- Spinner de carga verde -->
    <div class="maps-loading">
      <div class="spinner-border text-success" role="status">
        <span class="visually-hidden">Cargando mapa...</span>
      </div>
      <p class="mb-0 mt-2">Cargando ubicación del buque...</p>
    </div>
    } @else if (vesselInfo()?.vessel_imo) {
    <!-- Mapa disponible -->
    <div class="maps-header mb-2">
      <h6 class="mb-0">
        <i class="bi bi-geo-alt me-2"></i>
        Ubicación del Buque @if (vesselInfo()?.vessel_name) {
        <span class="vessel-name">- {{ vesselInfo()!.vessel_name }}</span>
        }
      </h6>
    </div>
    <app-vessel-map
      [imo]="+vesselInfo()!.vessel_imo!"
      [height]="'300'"
      [zoom]="'4'"
      [showTrack]="true"
    >
    </app-vessel-map>
    } @else {
    <!-- Sin datos de vessel -->
    <div class="maps-placeholder">
      <i class="bi bi-geo-alt"></i>
      <p class="mb-0">Localizado aun en origen</p>
    </div>
    }
  </div>

  <!-- Sección de Actividades (movimientos manuales NOTI) -->
  <div class="activities-section">
    <h6 class="mb-3">Actividades</h6>

    @if (movementsLoading()) {
    <div class="text-center py-3">
      <div class="spinner-border spinner-border-sm text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
    </div>
    } @else if (allMovements().length === 0) {
    <div class="text-muted text-center py-3">
      <i class="bi bi-inbox me-2"></i>No hay actividades registradas
    </div>
    } @else {
    <div class="table-responsive scrolleable-table">
      <table class="table table-hover">
        <thead>
          <tr>
            <th style="width: 170px">Fecha</th>
            <th>Detalle</th>
            @if (showAddNotification) {
            <th style="width: 100px" class="text-center">Acción</th>
            }
          </tr>
        </thead>
        <tbody>
          @for (movement of allMovements(); track movement.id) {
          <tr>
            @if (editingMovementId() === movement.id) {
            <!-- Modo edición (solo para NOTI) -->
            <td>
              <input
                type="datetime-local"
                class="form-control form-control-sm"
                [(ngModel)]="editingTimestamp"
              />
            </td>
            <td>
              <input
                type="text"
                class="form-control form-control-sm"
                [(ngModel)]="editingDetail"
                placeholder="Detalle de la actividad"
              />
            </td>
            <td class="text-center d-flex">
              <button
                type="button"
                class="btn btn-sm btn-success me-1"
                (click)="saveEdit(movement)"
                title="Guardar"
              >
                <i class="bi bi-check"></i>
              </button>
              <button
                type="button"
                class="btn btn-sm btn-secondary"
                (click)="cancelEdit()"
                title="Cancelar"
              >
                <i class="bi bi-x"></i>
              </button>
            </td>
            } @else {
            <!-- Modo visualización -->
            <td>{{ formatDateTime(movement.event_timestamp) }}</td>
            <td class="activity-detail">{{ movement.detail || '-' }}</td>
            @if (showAddNotification) {
            <td class="text-center d-flex">
              @if (isEditable(movement)) {
              <!-- Solo NOTI se puede editar/eliminar -->
              <button
                type="button"
                class="btn btn-sm btn-outline-primary me-1"
                (click)="startEdit(movement)"
                title="Editar"
              >
                <i class="bi bi-pencil-square"></i>
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger"
                (click)="deleteMovement(movement)"
                title="Eliminar"
              >
                <i class="bi bi-trash"></i>
              </button>
              } @else {
              <!-- Movimientos de Shipsgo: solo lectura -->
              <span class="text-muted" title="Movimiento de Shipsgo (solo lectura)">
                <i class="bi bi-lock"></i>
              </span>
              }
            </td>
            }
            }
          </tr>
          }
        </tbody>
      </table>
    </div>
    }
  </div>

  <!-- Sección de Agregar Actividad (solo visible desde Containers para admin) -->
  @if (showAddNotification) {
  <div class="add-activity-section">
    <h6>Agregar nueva actividad</h6>
    <textarea
      class="form-control"
      rows="3"
      placeholder="Escriba el detalle de la actividad"
      [(ngModel)]="newNotification"
      [disabled]="savingNotification()"
    >
    </textarea>
    <button
      type="button"
      class="btn btn-add-activity"
      (click)="onAddNotification()"
      [disabled]="!newNotification.trim() || savingNotification()"
    >
      @if (savingNotification()) {
      <span class="spinner-border spinner-border-sm me-1" role="status"></span>
      Guardando...
      } @else {
      Agregar
      }
    </button>
  </div>
  }

  <!-- Sección de Notas (solo visible para Cliente, NO para Admin) -->
  @if (!showAddNotification) {
  <div class="notes-section">
    <h6 class="mb-3">Notas</h6>

    @if (notificationsLoading()) {
    <div class="text-center py-3">
      <div class="spinner-border spinner-border-sm text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
    </div>
    } @else if (notifications().length === 0) {
    <div class="text-muted text-center py-3">
      <i class="bi bi-sticky me-2"></i>No hay notas registradas
    </div>
    } @else {
    <div class="table-responsive scrolleable-table">
      <table class="table table-hover">
        <thead>
          <tr>
            <th style="width: 170px">Fecha</th>
            <th>Detalle</th>
          </tr>
        </thead>
        <tbody>
          @for (notification of notifications(); track notification.id) {
          <tr>
            <td>{{ formatDateTime(notification.created_at) }}</td>
            <td class="notification-detail">{{ notification.message }}</td>
          </tr>
          }
        </tbody>
      </table>
    </div>
    }
  </div>
  }
  }

  <!-- Footer -->
  <div footer>
    <button type="button" class="btn btn-secondary" (click)="onClose()">Cerrar</button>
  </div>
</app-modal>
