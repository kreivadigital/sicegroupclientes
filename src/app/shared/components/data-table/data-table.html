<div class="data-table-container">
  <!-- Header con título, filtros y búsqueda -->
  @if (showHeader) {
    <div class="table-header">
      <!-- Título (izquierda) -->
      <div class="header-left">
        @if (title) {
          <h2 class="table-title">{{ title }}</h2>
        }
      </div>

      <!-- Filtros y búsqueda (derecha) -->
      <div class="header-right">
        <!-- Chips de filtros aplicados -->
        @if (showFilters && appliedFilters.length > 0) {
          <div class="applied-filters">
            @for (filter of appliedFilters; track filter.key) {
              <span class="filter-chip">
                {{ filter.label }}: {{ filter.displayValue }}
                <button type="button" class="chip-remove" (click)="removeFilter(filter)">
                  <i class="bi bi-x"></i>
                </button>
              </span>
            }
            @if (appliedFilters.length > 1) {
              <button type="button" class="btn-clear-all" (click)="clearAllFilters()">
                Limpiar todo
              </button>
            }
          </div>
        }

        <!-- Botón de filtros con dropdown -->
        @if (showFilters) {
          <div class="filter-dropdown-container">
            <button
              type="button"
              class="btn btn-outline-secondary btn-filter"
              (click)="toggleFilterDropdown()"
              [class.active]="showFilterDropdown || appliedFilters.length > 0">
              <i class="bi bi-sliders"></i>
              <!-- @if (appliedFilters.length > 0) {
                <span class="filter-count">{{ appliedFilters.length }}</span>
              } -->
            </button>

            <!-- Dropdown de filtros -->
            @if (showFilterDropdown) {
              <div class="filter-dropdown">
                <div class="dropdown-header">
                  <span>Filtrar por</span>
                  <button type="button" class="btn-close-dropdown" (click)="closeFilterDropdown()">
                    <i class="bi bi-x-lg"></i>
                  </button>
                </div>

                <div class="dropdown-body">
                  <!-- Filtro de Estado (checkboxes múltiples) -->
                  <div class="filter-group">
                    <label class="filter-label">Estado</label>
                    <div class="status-checkboxes">
                      @for (status of statusOptions; track status.value) {
                        <label class="checkbox-item" [class.selected]="isStatusSelected(status.value)">
                          <input
                            type="checkbox"
                            [checked]="isStatusSelected(status.value)"
                            (change)="toggleStatus(status.value)">
                          <span class="checkbox-label">{{ status.label }}</span>
                        </label>
                      }
                    </div>
                  </div>

                  <!-- Filtro de Fecha Desde -->
                  <div class="filter-group">
                    <label class="filter-label">Fecha desde</label>
                    <input
                      type="date"
                      class="form-control form-control-sm"
                      [(ngModel)]="dateFrom"
                      [max]="today">
                  </div>

                  <!-- Filtro de Fecha Hasta -->
                  <div class="filter-group">
                    <label class="filter-label">Fecha hasta</label>
                    <input
                      type="date"
                      class="form-control form-control-sm"
                      [(ngModel)]="dateTo"
                      [max]="today">
                  </div>
                </div>

                <div class="dropdown-footer">
                  <button type="button" class="btn btn-sm btn-secondary" (click)="closeFilterDropdown()">
                    Cancelar
                  </button>
                  <button type="button" class="btn btn-sm btn-primary" (click)="applyFilters()">
                    Aplicar Filtros
                  </button>
                </div>
              </div>

              <!-- Overlay para cerrar dropdown -->
              <div class="dropdown-overlay" (click)="closeFilterDropdown()"></div>
            }
          </div>
        }

        <!-- Barra de búsqueda -->
        @if (showSearch) {
          <div class="search-container">
            <i class="bi bi-search search-icon"></i>
            <input
              type="text"
              class="form-control search-input"
              placeholder="Buscar..."
              [value]="searchTerm"
              (input)="onSearchInput($event)">
          </div>
        }
      </div>
    </div>
  }

  @if (loading) {
  <div class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="text-muted mt-3">Cargando datos...</p>
  </div>
  } @else if (data.length === 0) {
  <div class="text-center py-5">
    <i class="bi bi-inbox fs-1 text-muted"></i>
    <p class="text-muted mt-3">{{ emptyMessage }}</p>
  </div>
  } @else if (filteredData.length === 0) {
  <div class="text-center py-5">
    <i class="bi bi-search fs-1 text-muted"></i>
    <p class="text-muted mt-3">No se encontraron resultados para "{{ searchTerm }}"</p>
  </div>
  } @else {
    <!-- Vista móvil: Cards (si hay template) -->
    @if (isMobile() && cardTemplate) {
      <div class="cards-container">
        @for (row of filteredData; track row.id || $index) {
          <ng-container
            [ngTemplateOutlet]="cardTemplate"
            [ngTemplateOutletContext]="{
              $implicit: row,
              row: row,
              actions: actions,
              onAction: handleCardAction,
              rowClass: getRowClass(row)
            }">
          </ng-container>
        }
      </div>
    } @else {
      <!-- Vista desktop: Tabla -->
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              @for (column of columns; track column.key) {
              <th>{{ column.label }}</th>
              } @if (actions.length > 0) {
              <th class="text-center" style="width: 120px">Acciones</th>
              }
            </tr>
          </thead>
          <tbody>
            @for (row of filteredData; track row.id || $index) {
            <tr [class]="getRowClass(row)">
              @for (column of columns; track column.key) {
              <td>
                @if (!column.type || column.type === 'text') {
                <span>{{ getCellValue(row, column) }}</span>
                } @if (column.type === 'badge') {
                <span [class]="'badge ' + getBadgeClass(column, getCellValue(row, column))">
                  {{ getBadgeLabel(column, getCellValue(row, column)) }}
                </span>
                } @if (column.type === 'date') {
                <span>{{ getCellValue(row, column) | date : 'dd/MM/yyyy' }}</span>
                } @if (column.type === 'percentage') {
                <span>{{ getCellValue(row, column) }}%</span>
                } @if (column.type === 'port-with-date') {
                <div class="port-info">
                  <div class="fw-semibold">
                    {{ getPortLocation(row, column) }}, {{ getPortCountry(row, column) }}
                  </div>
                  <div class="text-muted small">
                    {{ getPortDate(row, column) | date : 'dd/MM/yyyy' }}
                  </div>
                </div>
                } @if (column.type === 'progress') {
                <div class="progress-container">
                  <div class="progress" style="height: 8px">
                    <div
                      class="progress-bar bg-success"
                      role="progressbar"
                      [style.width.%]="getCellValue(row, column)"
                      [attr.aria-valuenow]="getCellValue(row, column)"
                      aria-valuemin="0"
                      aria-valuemax="100"
                    ></div>
                  </div>
                  <small class="text-muted ms-2">{{ getCellValue(row, column) }}%</small>
                </div>
                }
              </td>
              } @if (actions.length > 0) {
              <td class="text-center">
                <div class="btn-group btn-group-sm" role="group">
                  @for (action of actions; track action.action) {
                  <button
                    type="button"
                    [class]="'btn ' + (action.class || 'btn-outline-secondary')"
                    [title]="action.tooltip"
                    [disabled]="isActionDisabled(action.action, row)"
                    (click)="onActionClick(action, row)"
                  >
                    <i [class]="action.icon"></i>
                  </button>
                  }
                </div>
              </td>
              }
            </tr>
            }
          </tbody>
        </table>
      </div>
    }
  }
</div>
