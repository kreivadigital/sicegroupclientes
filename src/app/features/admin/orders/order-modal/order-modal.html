<app-modal [title]="getTitle()" [size]="'lg'" (close)="onClose()">
  @if (loading()) {
  <div class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>
  } @else {
  <form [formGroup]="form" (ngSubmit)="onSubmit()">
    <div class="row">
      <!-- Cliente -->
      <div class="col-12 mb-3">
        <label class="form-label">Cliente</label>
        @if (mode === 'view' && order()) {
        <input
          type="text"
          class="form-control"
          [value]="order()?.client?.company_name || ''"
          readonly
        />
        } @else {
        <select class="form-select" formControlName="client_id">
          <option value="">Seleccionar cliente</option>
          @for (client of clients(); track client.id) {
          <option [value]="client.id">{{ client.company_name }}</option>
          }
        </select>
        }
      </div>

      <!-- Descripción y Dirección de entrega -->
      <div class="col-md-6 mb-3">
        <label class="form-label">Descripción (opcional)</label>
        <textarea
          class="form-control"
          rows="3"
          formControlName="description"
          placeholder="Descripción"
        ></textarea>
      </div>

      <div class="col-md-6 mb-3">
        <label class="form-label">Dirección de entrega</label>
        <textarea
          class="form-control"
          rows="3"
          formControlName="delivery_address"
          placeholder="Agregar dirección"
        ></textarea>
      </div>

      <!-- Cantidad de bultos y Packin list -->
      <div class="col-md-6 mb-3">
        <label class="form-label">Cantidad de bultos</label>
        <input type="number" class="form-control" formControlName="bulk_quantity" placeholder="1" />
      </div>

      <div class="col-md-6 mb-3">
        <label class="form-label">Packin list (opcional)</label>
        @if (mode === 'view' && order()?.performa_pdf_path) {
        <div class="file-display">
          <i class="bi bi-file-earmark-spreadsheet me-2"></i>
          <span>packlist_GT-302025.xlsx</span>
          <button type="button" class="btn btn-sm btn-link">
            <i class="bi bi-download"></i>
          </button>
        </div>
        } @else {
        <button type="button" class="btn btn-secondary w-100" (click)="packinInput.click()">
          <i class="bi bi-upload me-2"></i>
          Adjuntar Excel
        </button>
        <input
          #packinInput
          type="file"
          class="d-none"
          accept=".xlsx,.xls"
          (change)="onFileSelect($event, 'packin')"
        />
        @if (packinListFile) {
        <small class="text-muted d-block mt-1">{{ packinListFile.name }}</small>
        } }
      </div>

      <!-- PDF Proforma y Factura -->
      <div class="col-md-6 mb-3">
        <label class="form-label">PDF Proforma (opcional)</label>
        @if (mode === 'view' && order()?.performa_pdf_path) {
        <div class="file-display">
          <i class="bi bi-file-earmark-pdf me-2"></i>
          <span>proforma_GT-1458.pdf</span>
          <button type="button" class="btn btn-sm btn-link">
            <i class="bi bi-download"></i>
          </button>
        </div>
        } @else {
        <button type="button" class="btn btn-secondary w-100" (click)="performaInput.click()">
          <i class="bi bi-upload me-2"></i>
          Adjuntar Excel
        </button>
        <input
          #performaInput
          type="file"
          class="d-none"
          accept=".pdf"
          (change)="onFileSelect($event, 'performa')"
        />
        @if (performaPdfFile) {
        <small class="text-muted d-block mt-1">{{ performaPdfFile.name }}</small>
        } }
      </div>

      <div class="col-md-6 mb-3">
        <label class="form-label">Factura (opcional)</label>
        @if (mode === 'view') {
        <div class="file-display">
          <i class="bi bi-file-earmark-pdf me-2"></i>
          <span>invoice_GT-1458.pdf</span>
          <button type="button" class="btn btn-sm btn-link">
            <i class="bi bi-download"></i>
          </button>
        </div>
        } @else {
        <button type="button" class="btn btn-secondary w-100" (click)="invoiceInput.click()">
          <i class="bi bi-upload me-2"></i>
          Adjuntar PDF
        </button>
        <input
          #invoiceInput
          type="file"
          class="d-none"
          accept=".pdf"
          (change)="onFileSelect($event, 'invoice')"
        />
        @if (invoiceFile) {
        <small class="text-muted d-block mt-1">{{ invoiceFile.name }}</small>
        } }
      </div>

      <!-- Estado y Contenedor -->
      <div class="col-md-6 mb-3">
        <label class="form-label">Estado</label>
        @if (mode === 'view' && order()) {
        <input type="text" class="form-control" [value]="order()?.status || ''" readonly />
        } @else {
        <select class="form-select" formControlName="status">
          <option value="pending">Pendiente</option>
          <option value="processing">En Proceso</option>
          <option value="shipped">En tránsito</option>
          <option value="delivered">Entregada</option>
          <option value="cancelled">Cancelada</option>
        </select>
        }
      </div>

      <div class="col-md-6 mb-3">
        <label class="form-label">Contenedor (opcional)</label>
        @if (mode === 'view' && order()?.container) {
        <input
          type="text"
          class="form-control"
          [value]="
            order()?.container?.container_number + ' - ' + order()?.container?.shipment_reference ||
            ''
          "
          readonly
        />
        } @else {
        <select class="form-select" formControlName="container_id">
          <option value="">Seleccionar contenedor</option>
          @for (container of containers(); track container.id) {
          <option [value]="container.id">
            {{ container.container_number }} - {{ container.shipment_reference }}
          </option>
          }
        </select>
        }
      </div>
    </div>
  </form>
  }

  <!-- Footer -->
  <div footer>
    @if (mode === 'view') {
    <button type="button" class="btn btn-secondary" (click)="onClose()">Cerrar</button>
    } @else {
    <button type="button" class="btn btn-secondary" (click)="onClose()" [disabled]="loading()">
      Cancelar
    </button>
    <button
      type="button"
      class="btn btn-success"
      (click)="onSubmit()"
      [disabled]="form.invalid || loading()"
    >
      @if (loading()) {
      <span class="spinner-border spinner-border-sm me-2"></span>
      }
      {{ mode === 'create' ? 'Agregar' : 'Actualizar' }}
    </button>
    }
  </div>
</app-modal>
