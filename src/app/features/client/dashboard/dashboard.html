<div class="client-dashboard-page">
  @if (loading()) {
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando estadísticas...</span>
      </div>
    </div>
  } @else {
    <!-- Tarjetas de estadísticas -->
    <div class="row g-3 mb-4">
      <!-- Pedidos Totales -->
      <div class="col-6 col-md-3">
        <app-stat-card
          title="Pedidos Totales"
          [value]="stats().total"
          icon="bi-box-seam"
          iconColor="#155DFC">
        </app-stat-card>
      </div>

      <!-- En Tránsito -->
      <div class="col-6 col-md-3">
        <app-stat-card
          title="En Tránsito"
          [value]="stats().in_transit"
          icon="bi-truck"
          iconColor="#FFDF20">
        </app-stat-card>
      </div>

      <!-- Entregados -->
      <div class="col-6 col-md-3">
        <app-stat-card
          title="Entregados"
          [value]="stats().delivered"
          icon="bi-check-circle"
          iconColor="#2AC364">
        </app-stat-card>
      </div>

      <!-- Retrasados -->
      <div class="col-6 col-md-3">
        <app-stat-card
          title="Retrasados"
          [value]="stats().delayed"
          icon="bi-exclamation-circle"
          iconColor="#E7000B">
        </app-stat-card>
      </div>
    </div>

    <!-- Tabla de órdenes -->
    <div class="row">
      <div class="col">
        <app-data-table
          title="Órdenes de Compra"
          [showFilters]="true"
          [showSearch]="true"
          [columns]="columns"
          [data]="orders()"
          [actions]="actions"
          [loading]="loadingOrders()"
          emptyMessage="No tienes órdenes registradas"
          (actionClick)="onTableAction($event)">

          <!-- Template para cards en móvil -->
          <ng-template #cardTemplate let-order let-actions="actions" let-onAction="onAction">
            <div class="order-card">
              <!-- Header: Orden # y Status -->
              <div class="card-header">
                <span class="order-number">Orden #{{ order.id }}</span>
                <span [class]="'badge bg-' + getStatusColor(order.status)">
                  {{ getStatusLabel(order.status) }}
                </span>
              </div>

              <!-- Referencia -->
              <div class="card-reference">
                <span class="reference-value">{{ order.container?.shipment_reference || '-' }}</span>
              </div>

              <!-- Puertos -->
              <div class="card-ports">
                <!-- Puerto de Origen -->
                <div class="port-item">
                  <span class="port-label">Puerto de Origen</span>
                  <span class="port-location">
                    {{ order.container?.port_of_loading_name || '-' }}
                    <span class="port-country">{{ order.container?.port_of_loading_country || '-' }}</span>
                  </span>
                  <span class="port-date">{{ order.container?.created_at_shipsgo | date:'dd/MM/yyyy' }}</span>
                </div>

                <!-- Conector -->
                <div class="port-connector">
                  <div class="connector-line"></div>
                  <div class="connector-dot"></div>
                </div>

                <!-- Puerto de Destino -->
                <div class="port-item">
                  <span class="port-label">Puerto de Destino</span>
                  <span class="port-location">
                    {{ order.container?.destination_port_name || '-' }}
                    <span class="port-country">{{ order.container?.destination_port_country || '-' }}</span>
                  </span>
                  <span class="port-date">{{ order.container?.date_of_discharge | date:'dd/MM/yyyy' }}</span>
                </div>
              </div>

              <!-- Acciones -->
              <div class="card-actions">
                <button
                  class="btn-view"
                  (click)="onAction({ action: 'view', row: order })">
                  <i class="bi bi-eye"></i>
                  <span>Ver Detalles</span>
                </button>
                @if (order.container_id) {
                  <button
                    class="btn-track"
                    (click)="onAction({ action: 'track', row: order })">
                    <i class="bi bi-geo-alt"></i>
                  </button>
                }
              </div>
            </div>
          </ng-template>

        </app-data-table>

        <!-- Pagination -->
        @if (orders().length > 0) {
          <app-pagination
            [currentPage]="currentPage()"
            [totalPages]="totalPages()"
            [totalItems]="totalItems()"
            [perPage]="perPage()"
            (pageChange)="onPageChange($event)">
          </app-pagination>
        }
      </div>
    </div>
  }

  <!-- Modal de detalle de orden -->
  @if (showModal()) {
    <app-order-modal
      mode="view"
      [orderId]="selectedOrderId()"
      (close)="onModalClose()"
      (save)="onOrderSaved($event)">
    </app-order-modal>
  }

  <!-- Modal de rastreo de contenedor -->
  @if (showTrackingModal() && selectedContainerId()) {
    <app-container-tracking-modal
      [containerId]="selectedContainerId()!"
      [orderNumber]="selectedOrderNumber()"
      [showAddNotification]="false"
      (close)="onTrackingModalClose()">
    </app-container-tracking-modal>
  }
</div>