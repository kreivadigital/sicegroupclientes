<div class="profile-page">
  @if (loading()) {
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
    </div>
  } @else if (client()) {
    <!-- Sección corta: Información del perfil -->
    <div class="profile-summary">
      <div class="profile-avatar">
        {{ getInitials() }}
      </div>

      <div class="profile-info">
        <h2 class="profile-name">{{ client()!.company_name }}</h2>
        <p class="profile-role">{{ getUserRole() }}</p>

        <div class="profile-contact">
          <div class="contact-item">
            <i class="bi bi-envelope"></i>
            <span>{{ personalInfoForm.value.email }}</span>
          </div>
          <div class="contact-item">
            <i class="bi bi-telephone"></i>
            <span>{{ personalInfoForm.value.phone }}</span>
          </div>
        </div>
      </div>

      @if (!isEditMode()) {
        <button type="button" class="btn btn-outline-primary edit-btn" (click)="toggleEditMode()">
          <i class="bi bi-pencil-square"></i>
          Editar perfil
        </button>
      }
    </div>

    <!-- Sección completa: Detalles del perfil -->
    <div class="profile-details">
      <!-- Mensajes de éxito -->
      @if (updateSuccess()) {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="bi bi-check-circle me-2"></i>
          Perfil actualizado correctamente
        </div>
      }

      <!-- Mensaje de error -->
      @if (updateError()) {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="bi bi-exclamation-circle me-2"></i>
          {{ updateError() }}
        </div>
      }

      <!-- Subsección: Información personal -->
      <div class="detail-section">
        <h6 class="section-title">Información personal</h6>
        <p class="section-subtitle">Actualiza tus datos personales y de contacto</p>

        <form [formGroup]="personalInfoForm" class="section-form">
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Nombre</label>
              <input
                type="text"
                class="form-control"
                formControlName="name"
                placeholder="Nombre completo"
                [class.is-invalid]="personalInfoForm.get('name')?.invalid && personalInfoForm.get('name')?.touched">
              @if (personalInfoForm.get('name')?.invalid && personalInfoForm.get('name')?.touched) {
                <div class="invalid-feedback">
                  El nombre es requerido
                </div>
              }
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Correo Electrónico</label>
              <input
                type="email"
                class="form-control"
                formControlName="email"
                placeholder="correo@ejemplo.com"
                [class.is-invalid]="personalInfoForm.get('email')?.invalid && personalInfoForm.get('email')?.touched">
              @if (personalInfoForm.get('email')?.hasError('required') && personalInfoForm.get('email')?.touched) {
                <div class="invalid-feedback">
                  El correo es requerido
                </div>
              } @else if (personalInfoForm.get('email')?.hasError('email') && personalInfoForm.get('email')?.touched) {
                <div class="invalid-feedback">
                  Ingresa un correo válido
                </div>
              }
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Teléfono</label>
              <input
                type="text"
                class="form-control"
                formControlName="phone"
                placeholder="+598 678 345"
                [class.is-invalid]="personalInfoForm.get('phone')?.invalid && personalInfoForm.get('phone')?.touched">
              @if (personalInfoForm.get('phone')?.invalid && personalInfoForm.get('phone')?.touched) {
                <div class="invalid-feedback">
                  El teléfono es requerido
                </div>
              }
            </div>
          </div>
        </form>
      </div>

      <!-- Subsección: Datos de la empresa -->
      <div class="detail-section">
        <h6 class="section-title">Datos de la empresa</h6>
        <p class="section-subtitle">Información de tu empresa</p>

        <form [formGroup]="companyInfoForm" class="section-form">
          <div class="row">
            <div class="col-md-8 mb-3">
              <label class="form-label">Dirección</label>
              <input
                type="text"
                class="form-control"
                formControlName="address"
                placeholder="Dirección completa"
                [class.is-invalid]="companyInfoForm.get('address')?.invalid && companyInfoForm.get('address')?.touched">
              @if (companyInfoForm.get('address')?.invalid && companyInfoForm.get('address')?.touched) {
                <div class="invalid-feedback">
                  La dirección es requerida
                </div>
              }
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">RUT</label>
              <input
                type="text"
                class="form-control"
                formControlName="rut"
                placeholder="12345678-9"
                [class.is-invalid]="companyInfoForm.get('rut')?.invalid && companyInfoForm.get('rut')?.touched">
              @if (companyInfoForm.get('rut')?.invalid && companyInfoForm.get('rut')?.touched) {
                <div class="invalid-feedback">
                  El RUT es requerido
                </div>
              }
            </div>
          </div>
        </form>

        @if (isEditMode()) {
          <div class="section-actions">
            <button type="button" class="btn btn-secondary" (click)="toggleEditMode()">
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-primary"
              (click)="onUpdateProfile()"
              [disabled]="loading()">
              @if (loading()) {
                <span class="spinner-border spinner-border-sm me-2"></span>
              }
              Guardar cambios
            </button>
          </div>
        }
      </div>

      <!-- Subsección: Seguridad -->
      <div class="detail-section">
        <h6 class="section-title">Seguridad</h6>
        <p class="section-subtitle">Cambiar contraseña</p>

        @if (passwordChangeSuccess()) {
          <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>
            Contraseña actualizada correctamente
          </div>
        }

        @if (passwordError()) {
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-circle me-2"></i>
            {{ passwordError() }}
          </div>
        }

        <form [formGroup]="securityForm" class="section-form">
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Contraseña actual</label>
              <input
                type="password"
                class="form-control"
                formControlName="current_password"
                placeholder="Contraseña actual"
                [class.is-invalid]="securityForm.get('current_password')?.invalid && securityForm.get('current_password')?.touched">
              @if (securityForm.get('current_password')?.invalid && securityForm.get('current_password')?.touched) {
                <div class="invalid-feedback">
                  La contraseña actual es requerida
                </div>
              }
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Nueva contraseña</label>
              <input
                type="password"
                class="form-control"
                formControlName="password"
                placeholder="Nueva contraseña"
                [class.is-invalid]="securityForm.get('password')?.invalid && securityForm.get('password')?.touched">
              @if (securityForm.get('password')?.hasError('required') && securityForm.get('password')?.touched) {
                <div class="invalid-feedback">
                  La nueva contraseña es requerida
                </div>
              } @else if (securityForm.get('password')?.hasError('minlength') && securityForm.get('password')?.touched) {
                <div class="invalid-feedback">
                  Mínimo 6 caracteres
                </div>
              }
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Confirmar contraseña</label>
              <input
                type="password"
                class="form-control"
                formControlName="password_confirmation"
                placeholder="Confirmar nueva contraseña"
                [class.is-invalid]="(securityForm.get('password_confirmation')?.invalid || securityForm.hasError('passwordMismatch')) && securityForm.get('password_confirmation')?.touched">
              @if (securityForm.get('password_confirmation')?.hasError('required') && securityForm.get('password_confirmation')?.touched) {
                <div class="invalid-feedback">
                  Confirma tu contraseña
                </div>
              } @else if (securityForm.hasError('passwordMismatch') && securityForm.get('password_confirmation')?.touched) {
                <div class="invalid-feedback">
                  Las contraseñas no coinciden
                </div>
              }
            </div>
          </div>

          <div class="section-actions">
            <button
              type="button"
              class="btn btn-primary"
              (click)="onChangePassword()"
              [disabled]="securityForm.invalid || loading()">
              @if (loading()) {
                <span class="spinner-border spinner-border-sm me-2"></span>
              }
              Actualizar contraseña
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>
